# üåæ Sistema de Controle de Permiss√µes para Propriedades Rurais

## üìã Resumo da Implementa√ß√£o

Sistema de permiss√µes baseado em perfis que controla quem pode criar e visualizar propriedades rurais com diferentes n√≠veis de impacto ambiental.

---

## üë• Hierarquia de Permiss√µes por Perfil

### 1. **üë§ Usu√°rio Comum**
- **Visualiza√ß√£o:**
  - ‚úÖ Pode visualizar apenas propriedades de **N√≠vel 1** (Baixo Impacto)
  - ‚ùå N√£o pode visualizar N√≠veis 2 e 3
- **Cria√ß√£o:**
  - ‚ùå N√£o pode cadastrar propriedades
- **Resumo:** Acesso somente leitura limitado ao n√≠vel mais baixo

### 2. **üëî Diretor de Divis√µes**
- **Visualiza√ß√£o:**
  - ‚úÖ Pode visualizar propriedades de **N√≠vel 1** (Baixo Impacto)
  - ‚úÖ Pode visualizar propriedades de **N√≠vel 2** (M√©dio Impacto)
  - ‚ùå N√£o pode visualizar N√≠vel 3
- **Cria√ß√£o:**
  - ‚úÖ Pode cadastrar propriedades de **N√≠vel 1**
  - ‚úÖ Pode cadastrar propriedades de **N√≠vel 2**
  - ‚ùå N√£o pode cadastrar N√≠vel 3
- **Resumo:** Controle total sobre n√≠veis 1 e 2

### 3. **üéñÔ∏è Ministro do Meio Ambiente**
- **Visualiza√ß√£o:**
  - ‚úÖ Pode visualizar propriedades de **N√≠vel 1** (Baixo Impacto)
  - ‚úÖ Pode visualizar propriedades de **N√≠vel 2** (M√©dio Impacto)
  - ‚úÖ Pode visualizar propriedades de **N√≠vel 3** (Alto Impacto)
- **Cria√ß√£o:**
  - ‚úÖ Pode cadastrar propriedades de **N√≠vel 1**
  - ‚úÖ Pode cadastrar propriedades de **N√≠vel 2**
  - ‚úÖ Pode cadastrar propriedades de **N√≠vel 3**
- **Resumo:** Acesso total a todos os n√≠veis

### 4. **‚öôÔ∏è Admin/Superuser (Django)**
- **Acesso total:** Igual ao Ministro
- **Especial:** Acesso via Django Admin tamb√©m

---

## üìä N√≠veis de Impacto Ambiental

### **N√≠vel 1 - Baixo Impacto** üü¢
- Contamina√ß√£o localizada
- Impacto ambiental revers√≠vel
- Monitoramento b√°sico necess√°rio

### **N√≠vel 2 - M√©dio Impacto** üü°
- Contamina√ß√£o regional
- Risco moderado aos recursos h√≠dricos
- Necessita interven√ß√£o e acompanhamento

### **N√≠vel 3 - Alto Impacto** üî¥
- Contamina√ß√£o severa e disseminada
- Alto risco ambiental e √† sa√∫de p√∫blica
- Requer a√ß√£o imediata e fiscaliza√ß√£o rigorosa

---

## üõ†Ô∏è Implementa√ß√£o T√©cnica

### **Fun√ß√µes Auxiliares** (`views.py`)

#### 1. `obter_niveis_visualizacao(usuario)`
Retorna lista de n√≠veis que o usu√°rio pode visualizar.

```python
def obter_niveis_visualizacao(usuario):
    """
    Retorna lista de n√≠veis de impacto que o usu√°rio pode visualizar.
    """
    if not usuario.is_authenticated:
        return []
    
    # Admin/Superuser podem ver todos
    if usuario.is_staff or usuario.is_superuser:
        return [1, 2, 3]
    
    # Verifica se tem perfil
    if not hasattr(usuario, 'perfil'):
        return [1]  # Padr√£o: apenas n√≠vel 1
    
    # Ministro pode ver todos os n√≠veis
    if usuario.perfil.tipo_perfil == 'MINISTRO':
        return [1, 2, 3]
    
    # Diretor pode ver n√≠veis 1 e 2
    if usuario.perfil.tipo_perfil == 'DIRETOR':
        return [1, 2]
    
    # Usu√°rio comum pode ver apenas n√≠vel 1
    return [1]
```

**Retorna:**
- Lista de inteiros: `[1]`, `[1, 2]` ou `[1, 2, 3]`

---

#### 2. `obter_niveis_criacao(usuario)`
Retorna lista de n√≠veis que o usu√°rio pode criar.

```python
def obter_niveis_criacao(usuario):
    """
    Retorna lista de n√≠veis de impacto que o usu√°rio pode criar.
    Retorna tuplas (valor, label) para usar em select.
    """
    # Admin/Superuser podem criar todos
    if usuario.is_staff or usuario.is_superuser:
        return [
            (1, 'N√≠vel 1 - Baixo Impacto'),
            (2, 'N√≠vel 2 - M√©dio Impacto'),
            (3, 'N√≠vel 3 - Alto Impacto'),
        ]
    
    # Ministro pode criar todos os n√≠veis
    if usuario.perfil.tipo_perfil == 'MINISTRO':
        return [
            (1, 'N√≠vel 1 - Baixo Impacto'),
            (2, 'N√≠vel 2 - M√©dio Impacto'),
            (3, 'N√≠vel 3 - Alto Impacto'),
        ]
    
    # Diretor pode criar n√≠veis 1 e 2
    if usuario.perfil.tipo_perfil == 'DIRETOR':
        return [
            (1, 'N√≠vel 1 - Baixo Impacto'),
            (2, 'N√≠vel 2 - M√©dio Impacto'),
        ]
    
    # Usu√°rio comum n√£o pode criar propriedades
    return []
```

**Retorna:**
- Lista de tuplas `(valor, label)` ou lista vazia

---

#### 3. `pode_criar_propriedades(usuario)`
Verifica se usu√°rio tem permiss√£o para criar propriedades.

```python
def pode_criar_propriedades(usuario):
    """Verifica se o usu√°rio tem permiss√£o para criar propriedades"""
    if not usuario.is_authenticated:
        return False
    
    # Admin pode criar
    if usuario.is_staff or usuario.is_superuser:
        return True
    
    # Verifica se tem perfil
    if not hasattr(usuario, 'perfil'):
        return False
    
    # Ministro e Diretor podem criar propriedades
    # Usu√°rio comum N√ÉO pode criar
    return usuario.perfil.tipo_perfil in ['MINISTRO', 'DIRETOR']
```

**Retorna:**
- `True`: Se pode criar propriedades
- `False`: Se n√£o pode criar

---

### **View `propriedades_list`**

Lista propriedades com filtro por permiss√£o:

```python
def propriedades_list(request):
    """Lista todas as propriedades rurais"""
    # ... c√≥digo de busca e filtros ...
    
    # Filtrar por n√≠veis que o usu√°rio pode visualizar
    niveis_permitidos = obter_niveis_visualizacao(request.user)
    propriedades = propriedades.filter(nivel_impacto__in=niveis_permitidos)
    
    context = {
        'page_obj': page_obj,
        'nivel_filtro': nivel_filtro,
        'search': search,
        'pode_criar': pode_criar_propriedades(request.user),
        'niveis_permitidos': niveis_permitidos,
    }
    return render(request, 'core/propriedades_list.html', context)
```

**Caracter√≠sticas:**
- ‚úÖ Filtra automaticamente propriedades por n√≠vel permitido
- ‚úÖ Passa flag `pode_criar` para controlar bot√£o
- ‚úÖ Passa `niveis_permitidos` para filtros

---

### **View `propriedade_detail`**

Visualiza detalhes com valida√ß√£o de permiss√£o:

```python
@login_required
def propriedade_detail(request, pk):
    """Visualiza detalhes de uma propriedade"""
    propriedade = get_object_or_404(PropriedadeRural, pk=pk, ativo=True)
    
    # Verificar se usu√°rio tem permiss√£o para ver este n√≠vel
    niveis_permitidos = obter_niveis_visualizacao(request.user)
    if propriedade.nivel_impacto not in niveis_permitidos:
        messages.error(request, 'Voc√™ n√£o tem permiss√£o para visualizar propriedades deste n√≠vel!')
        return redirect('propriedades_list')
    
    return render(request, 'core/propriedade_detail.html', {'propriedade': propriedade})
```

**Prote√ß√£o:**
- ‚ùå Bloqueia acesso direto via URL se n√£o tiver permiss√£o
- ‚úÖ Redireciona com mensagem de erro

---

### **View `propriedade_create`**

Cria propriedade com valida√ß√£o dupla:

```python
@login_required
def propriedade_create(request):
    """Cria uma nova propriedade"""
    # Verificar se usu√°rio pode criar propriedades
    if not pode_criar_propriedades(request.user):
        messages.error(request, 'Voc√™ n√£o tem permiss√£o para cadastrar propriedades!')
        return redirect('propriedades_list')
    
    niveis_permitidos = obter_niveis_criacao(request.user)
    
    if request.method == 'POST':
        try:
            nivel_escolhido = int(request.POST.get('nivel_impacto'))
            
            # Validar se o n√≠vel escolhido √© permitido
            niveis_valores = [n[0] for n in niveis_permitidos]
            if nivel_escolhido not in niveis_valores:
                messages.error(request, 'Voc√™ n√£o tem permiss√£o para cadastrar propriedades neste n√≠vel!')
                return render(request, 'core/propriedade_form.html', {
                    'niveis_permitidos': niveis_permitidos
                })
            
            # ... resto do c√≥digo de cria√ß√£o ...
```

**Valida√ß√µes:**
1. ‚úÖ Verifica se pode criar propriedades (Usu√°rio Comum = ‚ùå)
2. ‚úÖ Valida n√≠vel escolhido no POST
3. ‚úÖ Mostra apenas n√≠veis permitidos no select

---

### **View `propriedade_update`**

Atualiza propriedade com valida√ß√£o de n√≠vel:

```python
@login_required
def propriedade_update(request, pk):
    """Atualiza uma propriedade existente"""
    propriedade = get_object_or_404(PropriedadeRural, pk=pk, ativo=True)
    
    # Verificar se usu√°rio pode ver/editar este n√≠vel
    niveis_permitidos = obter_niveis_criacao(request.user)
    niveis_valores = [n[0] for n in niveis_permitidos]
    
    if propriedade.nivel_impacto not in niveis_valores:
        messages.error(request, 'Voc√™ n√£o tem permiss√£o para editar propriedades deste n√≠vel!')
        return redirect('propriedades_list')
    
    # ... valida√ß√£o do novo n√≠vel no POST ...
```

**Prote√ß√µes:**
- ‚ùå Bloqueia edi√ß√£o de propriedades de n√≠vel superior
- ‚úÖ Valida mudan√ßa de n√≠vel

---

## üé® Templates Atualizados

### **`propriedades_list.html`**

#### Bot√£o "Nova Propriedade" Condicional:
```django
<div class="page-header">
    <h1>üåæ Propriedades Rurais com Agrot√≥xicos Proibidos</h1>
    {% if pode_criar %}
    <a href="{% url 'propriedade_create' %}" class="btn-primary">
        + Nova Propriedade
    </a>
    {% endif %}
</div>
```

#### Filtro de N√≠veis Din√¢mico:
```django
<select name="nivel" class="filter-select">
    <option value="">Todos os N√≠veis</option>
    {% if 1 in niveis_permitidos %}
    <option value="1">N√≠vel 1 - Baixo Impacto</option>
    {% endif %}
    {% if 2 in niveis_permitidos %}
    <option value="2">N√≠vel 2 - M√©dio Impacto</option>
    {% endif %}
    {% if 3 in niveis_permitidos %}
    <option value="3">N√≠vel 3 - Alto Impacto</option>
    {% endif %}
</select>
```

---

### **`propriedade_form.html`**

#### Select de N√≠vel Din√¢mico:
```django
<select id="nivel_impacto" name="nivel_impacto" required>
    <option value="">Selecione</option>
    {% for nivel_valor, nivel_label in niveis_permitidos %}
    <option value="{{ nivel_valor }}" {% if propriedade.nivel_impacto == nivel_valor %}selected{% endif %}>
        {{ nivel_label }}
    </option>
    {% endfor %}
</select>

{% if niveis_permitidos|length == 0 %}
<small class="text-danger">Voc√™ n√£o tem permiss√£o para cadastrar propriedades.</small>
{% elif niveis_permitidos|length < 3 %}
<small class="text-muted">Voc√™ s√≥ pode cadastrar propriedades nos n√≠veis permitidos para o seu perfil.</small>
{% endif %}
```

**Caracter√≠sticas:**
- ‚úÖ Mostra apenas n√≠veis permitidos
- ‚úÖ Mensagem informativa sobre restri√ß√µes

---

## üîÑ Fluxos de Uso

### **Fluxo 1: Usu√°rio Comum visualiza propriedades**
1. Acessa lista de propriedades
2. V√™ apenas propriedades de N√≠vel 1
3. ‚ùå N√£o v√™ bot√£o "Nova Propriedade"
4. Se tentar acessar N√≠vel 2/3 via URL: bloqueado com erro

### **Fluxo 2: Diretor cria propriedade N√≠vel 2**
1. Acessa "Nova Propriedade"
2. Formul√°rio mostra apenas N√≠veis 1 e 2
3. Seleciona N√≠vel 2
4. Sistema valida e salva
5. Propriedade criada com sucesso

### **Fluxo 3: Diretor tenta criar N√≠vel 3**
1. Acessa formul√°rio
2. ‚ùå N√≠vel 3 n√£o aparece no select
3. Se tentar for√ßar via POST: bloqueado com erro
4. Sistema exibe mensagem de permiss√£o negada

### **Fluxo 4: Ministro gerencia todas**
1. V√™ todas as propriedades (1, 2 e 3)
2. Pode criar qualquer n√≠vel
3. Pode editar qualquer n√≠vel
4. Acesso total ao sistema

---

## üìä Matriz de Permiss√µes

### **Visualiza√ß√£o**

| Perfil / N√≠vel | N√≠vel 1 | N√≠vel 2 | N√≠vel 3 |
|----------------|---------|---------|---------|
| **Usu√°rio Comum** | ‚úÖ | ‚ùå | ‚ùå |
| **Diretor** | ‚úÖ | ‚úÖ | ‚ùå |
| **Ministro** | ‚úÖ | ‚úÖ | ‚úÖ |
| **Admin** | ‚úÖ | ‚úÖ | ‚úÖ |

### **Cria√ß√£o/Edi√ß√£o**

| Perfil / N√≠vel | N√≠vel 1 | N√≠vel 2 | N√≠vel 3 |
|----------------|---------|---------|---------|
| **Usu√°rio Comum** | ‚ùå | ‚ùå | ‚ùå |
| **Diretor** | ‚úÖ | ‚úÖ | ‚ùå |
| **Ministro** | ‚úÖ | ‚úÖ | ‚úÖ |
| **Admin** | ‚úÖ | ‚úÖ | ‚úÖ |

---

## üîí Seguran√ßa

### **Camadas de Prote√ß√£o:**

1. **Filtro no QuerySet:**
   ```python
   propriedades = propriedades.filter(nivel_impacto__in=niveis_permitidos)
   ```
   - ‚úÖ Usu√°rio nunca v√™ dados n√£o autorizados

2. **Valida√ß√£o no Detail:**
   ```python
   if propriedade.nivel_impacto not in niveis_permitidos:
       return redirect('propriedades_list')
   ```
   - ‚úÖ Bloqueia acesso direto via URL

3. **Valida√ß√£o no Create/Update:**
   ```python
   if nivel_escolhido not in niveis_valores:
       messages.error(request, 'Permiss√£o negada!')
   ```
   - ‚úÖ Previne manipula√ß√£o de formul√°rio

4. **Interface Adapt√°vel:**
   - ‚úÖ Select s√≥ mostra op√ß√µes permitidas
   - ‚úÖ Bot√µes aparecem conforme permiss√£o

---

## ‚úÖ Casos de Teste

### **Teste 1: Usu√°rio Comum acessa lista**
- ‚úÖ V√™ apenas propriedades N√≠vel 1
- ‚úÖ N√£o v√™ bot√£o "Nova Propriedade"
- ‚úÖ Filtro mostra apenas N√≠vel 1

### **Teste 2: Usu√°rio Comum tenta acessar N√≠vel 3 via URL**
- ‚úÖ Bloqueado com mensagem de erro
- ‚úÖ Redirecionado para lista

### **Teste 3: Diretor cria N√≠vel 2**
- ‚úÖ Formul√°rio mostra N√≠veis 1 e 2
- ‚úÖ Pode selecionar e salvar N√≠vel 2
- ‚úÖ Propriedade criada com sucesso

### **Teste 4: Diretor tenta criar N√≠vel 3 via POST manipulado**
- ‚úÖ Backend valida e rejeita
- ‚úÖ Mensagem de erro exibida
- ‚úÖ Propriedade n√£o √© criada

### **Teste 5: Ministro acessa tudo**
- ‚úÖ V√™ todas as propriedades (1, 2, 3)
- ‚úÖ Pode criar qualquer n√≠vel
- ‚úÖ Pode editar qualquer n√≠vel

---

## üéØ Benef√≠cios da Implementa√ß√£o

1. **üîê Seguran√ßa em Camadas:**
   - Backend valida tudo
   - Frontend adapta interface
   - Imposs√≠vel burlar permiss√µes

2. **üëÅÔ∏è Privacidade de Dados:**
   - Usu√°rios comuns n√£o veem casos graves (N√≠vel 3)
   - Informa√ß√µes sens√≠veis protegidas

3. **üìä Hierarquia Clara:**
   - Cada perfil tem escopo bem definido
   - Escala√ß√£o gradual de responsabilidade

4. **üé® UX Intuitiva:**
   - Usu√°rio s√≥ v√™ op√ß√µes v√°lidas
   - Sem tentativas frustradas

5. **‚ö° Performance:**
   - Filtro no banco de dados
   - N√£o carrega dados desnecess√°rios

---

## üöÄ Melhorias Futuras (Sugest√µes)

1. ‚ú® Log de auditoria (quem visualizou N√≠vel 3)
2. üîî Notifica√ß√µes para Ministros sobre novos N√≠vel 3
3. üìß Relat√≥rios peri√≥dicos por n√≠vel
4. üó∫Ô∏è Mapa interativo com n√≠veis por cor
5. üìà Dashboard com estat√≠sticas por n√≠vel
6. üîç Busca avan√ßada por crit√©rios de impacto
7. üì± App mobile com mesmas permiss√µes

---

## üìù Notas T√©cnicas

- ‚ö†Ô∏è Propriedades nunca s√£o deletadas, apenas desativadas (`ativo=False`)
- ‚ö†Ô∏è `usuario_cadastro` registra quem criou a propriedade
- ‚ö†Ô∏è Filtro `nivel_impacto__in` garante performance
- ‚ö†Ô∏è Valida√ß√£o dupla: frontend (UX) + backend (seguran√ßa)
- ‚ö†Ô∏è Permiss√µes verificadas em tempo real, n√£o cached

---

**Data de Implementa√ß√£o:** 4 de outubro de 2025  
**Status:** ‚úÖ Implementado e Testado  
**Integra√ß√£o:** Sistema de permiss√µes de usu√°rios + propriedades
