{% extends 'core/base.html' %}
{% load static %}
{% block title %}
{% if usuario_perfil %}Editar{% else %}Novo{% endif %} Usu√°rio
{% endblock %}
{% block extra_styles %}
<link rel="stylesheet" href="{% static 'core/css/usuarios.css' %}" />
{% endblock %} {% block content %}
<div class="form-container">
  <div class="form-header">
    <h2>
      {% if usuario_perfil %}
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
      </svg>
      {% else %}
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
        <circle cx="8.5" cy="7" r="4"></circle>
        <line x1="20" y1="8" x2="20" y2="14"></line>
        <line x1="23" y1="11" x2="17" y2="11"></line>
      </svg>
      {% endif %}
      {% if usuario_perfil %}Editar Usu√°rio{% else %}Novo Usu√°rio{% endif %}
    </h2>
    <p>
      {% if not usuario_perfil %}Cadastre-se e capture sua foto{% else %}Atualize suas informa√ß√µes{% endif %}
    </p>
  </div>

  <form method="post" class="user-form" id="userForm">
    {% csrf_token %}

    <div class="form-section">
      <h3>
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <circle cx="8.5" cy="8.5" r="1.5"></circle>
          <polyline points="21 15 16 10 5 21"></polyline>
        </svg>
        Foto do Perfil
      </h3>

      <div class="photo-capture-section">
        <div class="current-photo">
          {% if usuario_perfil.perfil.foto %}
          <img
            src="{{ usuario_perfil.perfil.foto.url }}"
            alt="Foto atual"
            id="previewImage"
          />
          {% else %}
          <div class="photo-placeholder" id="previewImage">
            <span>üì∑</span>
            <p>Sem foto</p>
          </div>
          {% endif %}
        </div>

        <div class="camera-section">
          <video id="video" autoplay style="display: none"></video>
          <canvas id="canvas" style="display: none"></canvas>
          <input type="file" id="fileInput" accept="image/*" style="display: none" />

          <div class="camera-buttons">
            <button type="button" id="startCamera" class="btn-secondary">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                <circle cx="12" cy="13" r="4"></circle>
              </svg>
              Abrir C√¢mera
            </button>
            <button type="button" id="selectFile" class="btn-secondary">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <polyline points="21 15 16 10 5 21"></polyline>
              </svg>
              Selecionar Foto
            </button>
            <button
              type="button"
              id="capturePhoto"
              class="btn-primary"
              style="display: none"
            >
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <circle cx="12" cy="12" r="3"></circle>
              </svg>
              Capturar Foto
            </button>
            <button
              type="button"
              id="retakePhoto"
              class="btn-warning"
              style="display: none"
            >
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="23 4 23 10 17 10"></polyline>
                <polyline points="1 20 1 14 7 14"></polyline>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
              </svg>
              Tirar Novamente
            </button>
            {% if usuario_perfil.perfil.foto %}
            <button type="button" id="deletePhoto" class="btn-danger">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
              </svg>
              Deletar Foto
            </button>
            {% endif %}
          </div>
        </div>

        <input type="hidden" id="foto_base64" name="foto_base64" />
        <input type="hidden" id="delete_foto" name="delete_foto" value="" />
      </div>
    </div>

    <div class="form-section">
      <h3>
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
        Dados de Acesso
      </h3>

      <div class="form-row">
        <div class="form-group">
          <label for="username">Nome de Usu√°rio *</label>
          <input
            type="text"
            id="username"
            name="username"
            required
            {% if usuario_perfil %}readonly{% endif %}
            value="{% if usuario_perfil %}{{ usuario_perfil.username }}{% endif %}"
            placeholder="ex: joao.silva"
          />
        </div>

        <div class="form-group">
          <label for="email">Email *</label>
          <input
            type="email"
            id="email"
            name="email"
            required
            value="{% if usuario_perfil %}{{ usuario_perfil.email }}{% endif %}"
            placeholder="ex: joao@email.com"
          />
        </div>
      </div>

      {% if usuario_perfil and request.user.is_staff %}
      <!-- Apenas admin pode alterar o tipo de perfil -->
      <div class="form-row">
        <div class="form-group">
          <label for="tipo_perfil">Tipo de Perfil *</label>
          <select
            id="tipo_perfil"
            name="tipo_perfil"
            required
            class="select-input"
          >
            <option value="COMUM" {% if usuario_perfil and usuario_perfil.perfil.tipo_perfil == 'COMUM' %}selected{% endif %}>
              üë§ Usu√°rio Comum
            </option>
            <option value="DIRETOR" {% if usuario_perfil and usuario_perfil.perfil.tipo_perfil == 'DIRETOR' %}selected{% endif %}>
              üëî Diretor de Divis√µes
            </option>
            <option value="MINISTRO" {% if usuario_perfil and usuario_perfil.perfil.tipo_perfil == 'MINISTRO' %}selected{% endif %}>
              üéñÔ∏è Ministro do Meio Ambiente
            </option>
          </select>
        </div>
      </div>
      {% elif usuario_perfil %}
      <!-- Usu√°rio comum editando seu pr√≥prio perfil - mostra mas n√£o permite alterar -->
      <div class="form-row">
        <div class="form-group">
          <label for="tipo_perfil_display">Tipo de Perfil</label>
          <input
            type="text"
            id="tipo_perfil_display"
            class="input-readonly"
            value="{{ usuario_perfil.perfil.get_tipo_perfil_display_icon }} {{ usuario_perfil.perfil.get_tipo_perfil_display }}"
            readonly
            disabled
          />
          <input type="hidden" name="tipo_perfil" value="{{ usuario_perfil.perfil.tipo_perfil }}" />
          <small class="text-muted">Apenas administradores podem alterar o tipo de perfil</small>
        </div>
      </div>
      {% elif is_admin_creating and perfis_permitidos %}
      <!-- Admin/Ministro/Diretor criando novo usu√°rio - pode escolher o tipo -->
      <div class="form-row">
        <div class="form-group">
          <label for="tipo_perfil">Tipo de Perfil *</label>
          <select
            id="tipo_perfil"
            name="tipo_perfil"
            required
            class="select-input"
          >
            {% for valor, label in perfis_permitidos %}
            <option value="{{ valor }}">{{ label }}</option>
            {% endfor %}
          </select>
          <small class="text-muted">Selecione o tipo de perfil para o novo usu√°rio</small>
        </div>
      </div>
      {% else %}
      <!-- Novo cadastro (auto-cadastro) - sempre ser√° Usu√°rio Comum (campo oculto) -->
      <input type="hidden" name="tipo_perfil" value="COMUM" />
      <div class="form-row">
        <div class="form-group">
          <div class="info-box">
            <p><strong>Seu perfil inicial:</strong> Usu√°rio Comum</p>
            <small>Voc√™ ser√° cadastrado como Usu√°rio Comum. Para outros tipos de perfil, entre em contato com um administrador.</small>
          </div>
        </div>
      </div>
      {% endif %}

      <div class="form-row">
        <div class="form-group">
          <label
            for="{% if usuario_perfil %}new_password{% else %}password{% endif %}"
          >
            {% if usuario_perfil %}Nova Senha (deixe em branco para manter){% else %}Senha *{% endif %}
          </label>
          <input
            type="password"
            id="{% if usuario_perfil %}new_password{% else %}password{% endif %}"
            name="{% if usuario_perfil %}new_password{% else %}password{% endif %}"
            {% if not usuario_perfil %}required{% endif %}
            placeholder="Digite a senha"
          />
        </div>

        <div class="form-group">
          <label for="password_confirm">
            {% if usuario_perfil %}Confirmar Nova Senha{% else %}Confirmar Senha
            *{% endif %}
          </label>
          <input
            type="password"
            id="password_confirm"
            name="password_confirm"
            {% if not usuario_perfil %}required{% endif %}
            placeholder="Confirme a senha"
          />
        </div>
      </div>
    </div>

    <div class="form-section">
      <h3>
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
        Informa√ß√µes Pessoais
      </h3>

      <div class="form-row">
        <div class="form-group">
          <label for="first_name">Nome *</label>
          <input
            type="text"
            id="first_name"
            name="first_name"
            required
            value="{% if usuario_perfil %}{{ usuario_perfil.first_name }}{% endif %}"
            placeholder="ex: Jo√£o"
          />
        </div>

        <div class="form-group">
          <label for="last_name">Sobrenome *</label>
          <input
            type="text"
            id="last_name"
            name="last_name"
            required
            value="{% if usuario_perfil %}{{ usuario_perfil.last_name }}{% endif %}"
            placeholder="ex: Silva"
          />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="cpf">CPF</label>
          <input
            type="text"
            id="cpf"
            name="cpf"
            value="{% if usuario_perfil %}{{ usuario_perfil.perfil.cpf }}{% endif %}"
            placeholder="000.000.000-00"
            maxlength="14"
          />
        </div>

        <div class="form-group">
          <label for="telefone">Telefone</label>
          <input
            type="text"
            id="telefone"
            name="telefone"
            value="{% if usuario_perfil %}{{ usuario_perfil.perfil.telefone }}{% endif %}"
            placeholder="(00) 00000-0000"
          />
        </div>
      </div>

      <div class="form-group">
        <label for="data_nascimento">Data de Nascimento</label>
        <input
          type="date"
          id="data_nascimento"
          name="data_nascimento"
          value="{% if usuario_perfil.perfil.data_nascimento %}{{ usuario_perfil.perfil.data_nascimento|date:'Y-m-d' }}{% endif %}"
        />
      </div>

      <div class="form-group">
        <label for="endereco">Endere√ßo</label>
        <textarea
          id="endereco"
          name="endereco"
          rows="2"
          placeholder="Rua, n√∫mero, bairro, cidade - UF"
        >
{% if usuario_perfil %}{{ usuario_perfil.perfil.endereco }}{% endif %}</textarea
        >
      </div>

      <div class="form-group">
        <label for="bio">Biografia</label>
        <textarea
          id="bio"
          name="bio"
          rows="3"
          maxlength="500"
          placeholder="Conte um pouco sobre voc√™..."
        >
{% if usuario_perfil %}{{ usuario_perfil.perfil.bio }}{% endif %}</textarea
        >
        <small class="form-help">M√°ximo 500 caracteres</small>
      </div>
    </div>

    <div class="form-actions">
      <button type="submit" class="btn-primary">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
          <polyline points="17 21 17 13 7 13 7 21"></polyline>
          <polyline points="7 3 7 8 15 8"></polyline>
        </svg>
        {% if usuario_perfil %}Salvar Altera√ß√µes{% else %}Cadastrar{% endif %}
      </button>
      <a
        href="{% if usuario_perfil %}{% url 'usuario_detail' usuario_perfil.pk %}{% else %}{% url 'login' %}{% endif %}"
        class="btn-secondary"
      >
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
        Cancelar
      </a>
    </div>
  </form>
</div>

{% endblock %} {% block scripts %}
<script src="{% static 'core/js/usuario_form.js' %}"></script>
{% endblock %}
